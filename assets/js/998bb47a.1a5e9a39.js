(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[748],{3905:function(e,t,a){"use strict";a.d(t,{Zo:function(){return p},kt:function(){return m}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),u=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=u(e.components);return n.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),c=u(a),m=r,k=c["".concat(s,".").concat(m)]||c[m]||d[m]||l;return a?n.createElement(k,i(i({ref:t},p),{},{components:a})):n.createElement(k,i({ref:t},p))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,i=new Array(l);i[0]=c;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var u=2;u<l;u++)i[u]=a[u];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},9589:function(e,t,a){"use strict";a.r(t),a.d(t,{frontMatter:function(){return o},contentTitle:function(){return s},metadata:function(){return u},toc:function(){return p},default:function(){return c}});var n=a(2122),r=a(9756),l=(a(7294),a(3905)),i=["components"],o={title:"Storage Rules"},s=void 0,u={unversionedId:"storage-rules",id:"storage-rules",isDocsHomePage:!1,title:"Storage Rules",description:"File authorization is tricky to manage, and means developers need to spend a lot of time on authentication and authorization. Using Hasura Backend Plus means all this complex code is done for you! All you need to do is set out file access rules, which makes creating and updating rules easy to manage.",source:"@site/docs/storage-rules.md",sourceDirName:".",slug:"/storage-rules",permalink:"/hasura-backend-plus/docs/storage-rules",editUrl:"https://github.com/nhost/hasura-backend-plus/edit/master/docs/docs/storage-rules.md",version:"current",frontMatter:{title:"Storage Rules"},sidebar:"tutorialSidebar",previous:{title:"OAuth Providers",permalink:"/hasura-backend-plus/docs/oauth-providers"},next:{title:"Emails",permalink:"/hasura-backend-plus/docs/emails"}},p=[],d={toc:p};function c(e){var t=e.components,a=(0,r.Z)(e,i);return(0,l.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"File authorization is tricky to manage, and means developers need to spend a lot of time on authentication and authorization. Using Hasura Backend Plus means all this complex code is done for you! All you need to do is set out file access rules, which makes creating and updating rules easy to manage."),(0,l.kt)("p",null,"The rules are set in a ",(0,l.kt)("inlineCode",{parentName:"p"},"yaml")," file, and let you control granular access to files and folders. Hasura Backend Plus comes with a ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/nhost/hasura-backend-plus/blob/master/custom/storage-rules/rules.yaml"},"rules template"),", which you can change for your specific project:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'functions:\n  isAuthenticated: "return !!request.auth"\n  isOwner: "return !!request.auth && userId === request.auth[\'user-id\']"\n  validToken: "return request.query.token === resource.Metadata.token"\npaths:\n  /user/:userId/:\n    list: "isOwner(userId)"\n  /user/:userId/:fileId:\n    read: "isOwner(userId) || validToken()"\n    write: "isOwner(userId)"\n')),(0,l.kt)("p",null,"The ",(0,l.kt)("inlineCode",{parentName:"p"},"yaml")," file is split into the following sections:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#paths"},"Paths")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#storage-functions"},"Storage functions"))),(0,l.kt)("hr",null),(0,l.kt)("h4",{id:"paths"},"Paths"),(0,l.kt)("p",null,"Paths allow you to define authorization permissions to your folders and files. This means you can control access to files, folders, and subfolders easily."),(0,l.kt)("p",null,"Paths can be static or dynamic, and dynamic paths can be used as variables within storage functions."),(0,l.kt)("h5",{id:"folder-paths"},"Folder paths"),(0,l.kt)("p",null,"Folder paths"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"paths:\n  /user/:userId/files/:\n    # Rules\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"Note the trailing slash"),". This is how you define folder paths."),(0,l.kt)("p",null,"You can use this to add permissions to listing files in a directory or downloading a ",(0,l.kt)("inlineCode",{parentName:"p"},".zip")," file of all the files."),(0,l.kt)("h5",{id:"file-paths"},"File paths"),(0,l.kt)("p",null,"File paths define rules for the individual files within your storage."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"paths:\n  /user/:userId/files/:fileId:\n    # Rules\n")),(0,l.kt)("p",null,"Here, the ",(0,l.kt)("inlineCode",{parentName:"p"},"/user")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"/files")," parts are static paths. The ",(0,l.kt)("inlineCode",{parentName:"p"},":userId")," and ",(0,l.kt)("inlineCode",{parentName:"p"},":fileId")," parts are dynamic paths."),(0,l.kt)("p",null,"Here's an example path that would be validated by this rule:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-txt"},"/user/1/files/image.png\n")),(0,l.kt)("h4",{id:"rules"},"Rules"),(0,l.kt)("p",null,"You can specify the following rules in your ",(0,l.kt)("inlineCode",{parentName:"p"},"rules.yaml")," file:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Action"),(0,l.kt)("th",{parentName:"tr",align:null},"Metadata (",(0,l.kt)("inlineCode",{parentName:"th"},"/m/"),")"),(0,l.kt)("th",{parentName:"tr",align:null},"Object (",(0,l.kt)("inlineCode",{parentName:"th"},"/o/"),")"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Folder: ",(0,l.kt)("inlineCode",{parentName:"td"},"create")),(0,l.kt)("td",{parentName:"tr",align:null},"N/A"),(0,l.kt)("td",{parentName:"tr",align:null},"N/A")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Folder: ",(0,l.kt)("inlineCode",{parentName:"td"},"update")),(0,l.kt)("td",{parentName:"tr",align:null},"N/A"),(0,l.kt)("td",{parentName:"tr",align:null},"N/A")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Folder: ",(0,l.kt)("inlineCode",{parentName:"td"},"list")),(0,l.kt)("td",{parentName:"tr",align:null},"Get metadata for accessible files"),(0,l.kt)("td",{parentName:"tr",align:null},"Get ",(0,l.kt)("inlineCode",{parentName:"td"},".zip")," folder of accessible files")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Folder: ",(0,l.kt)("inlineCode",{parentName:"td"},"get")),(0,l.kt)("td",{parentName:"tr",align:null},"N/A"),(0,l.kt)("td",{parentName:"tr",align:null},"N/A")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Folder: ",(0,l.kt)("inlineCode",{parentName:"td"},"delete")),(0,l.kt)("td",{parentName:"tr",align:null},"N/A"),(0,l.kt)("td",{parentName:"tr",align:null},"N/A")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"\xa0"),(0,l.kt)("td",{parentName:"tr",align:null}),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"File: ",(0,l.kt)("inlineCode",{parentName:"td"},"create")),(0,l.kt)("td",{parentName:"tr",align:null},"N/A"),(0,l.kt)("td",{parentName:"tr",align:null},"Create file")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"File: ",(0,l.kt)("inlineCode",{parentName:"td"},"update")),(0,l.kt)("td",{parentName:"tr",align:null},"Update metadata"),(0,l.kt)("td",{parentName:"tr",align:null},"Update file")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"File: ",(0,l.kt)("inlineCode",{parentName:"td"},"list")),(0,l.kt)("td",{parentName:"tr",align:null},"N/A"),(0,l.kt)("td",{parentName:"tr",align:null},"N/A")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"File: ",(0,l.kt)("inlineCode",{parentName:"td"},"get")),(0,l.kt)("td",{parentName:"tr",align:null},"Get file metadata"),(0,l.kt)("td",{parentName:"tr",align:null},"Get file")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"File: ",(0,l.kt)("inlineCode",{parentName:"td"},"delete")),(0,l.kt)("td",{parentName:"tr",align:null},"N/A"),(0,l.kt)("td",{parentName:"tr",align:null},"Delete the file")))),(0,l.kt)("p",null,"For simple allow/deny, you can return boolean values (",(0,l.kt)("inlineCode",{parentName:"p"},"true"),"/",(0,l.kt)("inlineCode",{parentName:"p"},"false"),") in a string."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'paths:\n  /public:\n    list: "true"\n  /private:\n    list: "false"\n')),(0,l.kt)("p",null,"For any complex permissions using variables, you should use ",(0,l.kt)("a",{parentName:"p",href:"#storage-functions"},"storage functions"),"."),(0,l.kt)("h5",{id:"file-tokens"},"File tokens"),(0,l.kt)("p",null,"When you upload a file to Hasura Backend Plus, a token is automatically added to the file metadata. This is unique for the file, and can be used as an access token.\nYou can create a ",(0,l.kt)("inlineCode",{parentName:"p"},"validToken")," storage function, and use that to allow access to the file, even if a user is unauthenticated."),(0,l.kt)("p",null,"We can define a rule to allow access to this image if the right token (in this case ",(0,l.kt)("inlineCode",{parentName:"p"},"c9aa7344-1b4c-42d2-81c0-48ee401a3eeb"),") is present:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-txt"},"/storage/o/private/secret-image.jpg?token=c9aa7344-1b4c-42d2-81c0-48ee401a3eeb\n")),(0,l.kt)("p",null,"The token is sent as a query parameter, which you can access on the ",(0,l.kt)("inlineCode",{parentName:"p"},"request")," object. You can check the token against the ",(0,l.kt)("inlineCode",{parentName:"p"},"resource.Metadata.token")," variable:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'functions:\n  validToken: "return request.query.token === resource.Metadata.token"\n')),(0,l.kt)("p",null,"You can now use the ",(0,l.kt)("inlineCode",{parentName:"p"},"validToken")," storage function to allow anyone to see the file with the correct token:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'functions:\n  validToken: "return request.query.token === resource.Metadata.token"\npaths:\n  /private/:fileId:\n    read: "validToken()"\n')),(0,l.kt)("h4",{id:"storage-functions"},"Storage functions"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"It is not possible to call storage functions inside other functions")),(0,l.kt)("p",null,"Storage functions allow you to define permissions which can be used by any rules. Storage functions have access to the query string of the request, and the permission variables cookie returned by the ",(0,l.kt)("a",{parentName:"p",href:"/docs/api-reference#authlogin"},"login")," or ",(0,l.kt)("a",{parentName:"p",href:"/docs/api-reference#authtokenrefresh"},"refresh")," endpoints."),(0,l.kt)("p",null,"You can have a look at the permission variables by examining the ",(0,l.kt)("inlineCode",{parentName:"p"},"permission_variables")," cookie. This is a URL-encoded string, in the following template:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-txt"},"s:<request.auth>.<checksum>\n")),(0,l.kt)("p",null,"The ",(0,l.kt)("inlineCode",{parentName:"p"},"request.auth")," part is a JSON object, which is the same as the ",(0,l.kt)("a",{parentName:"p",href:"https://hasura.io/docs/1.0/graphql/manual/auth/authentication/index.html#overview"},"Hasura permission variables")," but with the ",(0,l.kt)("inlineCode",{parentName:"p"},"x-hasura-")," prefix removed:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "user-id": "73f5d02c-484a-4003-98e4-bad5c6001882",\n  "allowed-roles": ["user"],\n  "default-role": "user"\n}\n')),(0,l.kt)("p",null,"You can access these variables through ",(0,l.kt)("inlineCode",{parentName:"p"},"request.auth")," (for example ",(0,l.kt)("inlineCode",{parentName:"p"},"request.auth['default-role']"),") when creating your storage rules."),(0,l.kt)("p",null,"A simple storage function would be to test if a user is authenticated. You can do this by checking if ",(0,l.kt)("inlineCode",{parentName:"p"},"request.auth")," is present:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'functions:\n  isAuthenticated: "return !!request.auth"\n')),(0,l.kt)("p",null,"Now, you can use this storage function within a storage path:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"functions:\n  isAuthenticated: 'return !!request.auth'\npaths:\n  /everyone/:\n    list: 'isAuthenticated()\n")),(0,l.kt)("p",null,"This will allow any logged-in user to access the files in the ",(0,l.kt)("inlineCode",{parentName:"p"},"/everyone/")," directory. If someone isn't logged in, they won't be able to see them."),(0,l.kt)("p",null,"You can also add more complex rules. For example, if you would like to allow users to access files within a folder named as their user id, you can add the following storage function:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"functions:\n  isOwner: 'return !!request.auth && request.auth[\"user-id\"] === userId'\n")),(0,l.kt)("p",null,"This function checks that a user is logged in, but also uses a variable called ",(0,l.kt)("inlineCode",{parentName:"p"},"userId"),", which must be passed in by the rule from a ",(0,l.kt)("a",{parentName:"p",href:"#folder-paths"},"dynamic path"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'functions:\n  isOwner: \'return !!request.auth && request.auth["user-id"] === userId\'\npaths:\n  /:userId/:\n    list: "isOwner(userId)"\n  /:userId/:fileId:\n    read: "isOwner(userId)"\n')),(0,l.kt)("p",null,"This rule will allow users to list their own file directory, and read their own files."),(0,l.kt)("h4",{id:"adding-variables"},"Adding variables"),(0,l.kt)("p",null,"Say you have many users that belong to different companies. You need to allow users to see files belonging to their own company, but not files belonging to other companies."),(0,l.kt)("p",null,"You will need a ",(0,l.kt)("inlineCode",{parentName:"p"},"company_id")," column on your ",(0,l.kt)("inlineCode",{parentName:"p"},"users")," table, and from this we can add appropriate permissions."),(0,l.kt)("p",null,"First, you need to add this column to the authentication permission variables, so that the ",(0,l.kt)("inlineCode",{parentName:"p"},"request.auth")," now contains this variable:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "user-id": "73f5d02c-484a-4003-98e4-bad5c6001882",\n  "allowed-roles": ["user"],\n  "default-role": "user",\n  "company-id": "e04567bf-884d-46f0-898e-bac1a260e128"\n}\n')),(0,l.kt)("p",null,"Now, you can add the following storage functions to your ",(0,l.kt)("inlineCode",{parentName:"p"},"rules.yaml"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'functions:\n  employedBy: \'return !!request.auth && request.auth["company-id"] === companyId\'\npaths:\n  /:companyId/:\n    list: "employedBy(companyId)"\n  /:companyId/:fileId:\n    read: "employedBy(companyId) && validToken()"\n    write: "employedBy(companyId)"\n')),(0,l.kt)("p",null,"How does this work? The ",(0,l.kt)("inlineCode",{parentName:"p"},":companyId")," path creates a variable called ",(0,l.kt)("inlineCode",{parentName:"p"},"companyId"),", which can be passed into a function.\nThis gets passed into the ",(0,l.kt)("inlineCode",{parentName:"p"},"employedBy()")," function, (called ",(0,l.kt)("inlineCode",{parentName:"p"},"companyId"),"), and can be compared to ",(0,l.kt)("inlineCode",{parentName:"p"},"request.auth['company-id']")," from the ",(0,l.kt)("inlineCode",{parentName:"p"},"permission_variables")," cookie."))}c.isMDXComponent=!0}}]);